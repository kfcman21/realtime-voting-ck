<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íˆ¬í‘œ ê´€ë¦¬ì í˜ì´ì§€</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-800 font-sans">

    <div class="container max-w-4xl mx-auto p-4 sm:p-6">
        
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-white">ğŸ”‘ íˆ¬í‘œ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
        </header>

        <div id="admin-section" class="bg-white p-6 rounded-xl shadow-lg">
            <div id="login-form">
                <h2 class="text-2xl font-bold text-slate-700 mb-4 text-center">ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
                <input type="email" id="admin-email" placeholder="ì´ë©”ì¼" class="w-full p-3 border border-gray-300 rounded-md mb-3">
                <input type="password" id="admin-password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full p-3 border border-gray-300 rounded-md">
                <button onclick="adminLogin()" class="w-full mt-4 bg-blue-600 text-white font-semibold py-3 rounded-md hover:bg-blue-700">ë¡œê·¸ì¸</button>
            </div>
            
            <div id="admin-panel" class="hidden">
                 <div class="flex justify-between items-center mb-6">
                    <h2 id="welcome-admin" class="text-2xl font-bold text-slate-700">âœ¨ ì£¼ì œ ê´€ë¦¬</h2>
                    <button onclick="adminLogout()" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-600">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
                 </div>
                 
                 <div class="bg-green-50 p-4 rounded-lg border border-green-200 mb-6">
                    <h3 class="font-bold text-lg text-green-800 mb-2">ìƒˆ ì£¼ì œ ë§Œë“¤ê¸°</h3>
                    <input type="text" id="new-topic-title" placeholder="ì£¼ì œ ì œëª©" class="w-full p-3 border border-gray-300 rounded-md mb-3">
                    <input type="text" id="new-topic-items" placeholder="í•­ëª©ë“¤ì„ ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥" class="w-full p-3 border border-gray-300 rounded-md mb-4">
                    <button onclick="createTopic()" class="w-full bg-green-600 text-white font-semibold py-3 px-6 rounded-md hover:bg-green-700 transition">ì£¼ì œ ìƒì„±</button>
                 </div>
                 
                 <hr class="my-6">
                 
                 <h3 class="font-bold text-lg text-slate-700 mb-2">ë‚´ ì£¼ì œ ëª©ë¡</h3>
                 <div id="topics-list" class="space-y-4">
                     </div>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div class="relative mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">âœï¸ ì£¼ì œ ìˆ˜ì •</h3>
                <div class="mt-2 px-7 py-3">
                    <label for="edit-topic-title" class="text-left block text-sm font-medium text-gray-700">ì£¼ì œ ì œëª©</label>
                    <input type="text" id="edit-topic-title" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                    
                    <label for="edit-topic-items" class="text-left block text-sm font-medium text-gray-700 mt-4">í•­ëª© (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                    <input type="text" id="edit-topic-items" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                    <p class="text-xs text-orange-500 mt-1">â€» í•­ëª© ìˆ˜ì • ì‹œ, ê¸°ì¡´ íˆ¬í‘œëŠ” ëª¨ë‘ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.</p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="save-edit-btn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-auto hover:bg-green-600">
                        ë³€ê²½ì‚¬í•­ ì €ì¥
                    </button>
                    <button id="cancel-edit-btn" onclick="closeEditModal()" class="ml-2 px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-auto hover:bg-gray-400">
                        ì·¨ì†Œ
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase ì„¤ì • ë¶™ì—¬ë„£ê¸°
        const firebaseConfig = {
             apiKey: "AIzaSyBg6oQzlAEUmKgfoc9wzW_WnRGzCD-NgzI",
             authDomain: "realtime-voting-ck.firebaseapp.com",
             projectId: "realtime-voting-ck",
             storageBucket: "realtime-voting-ck.firebasestorage.app",
             messagingSenderId: "920253088767",
             appId: "1:920253088767:web:51d64912cd92fc18d05dca",
             measurementId: "G-KZBYM1TCG5"

        };
        
        // Firebase ì„œë¹„ìŠ¤ ì´ˆê¸°í™”
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const topicsCollection = db.collection('topics');
        
        let loggedInAdmin = null; // ë¡œê·¸ì¸í•œ ê´€ë¦¬ì ì •ë³´ ì €ì¥ ë³€ìˆ˜
        let currentTopics = [];   // í˜„ì¬ ê´€ë¦¬ìì˜ ì£¼ì œ ëª©ë¡ ì €ì¥ ë³€ìˆ˜
        let unsubscribe;          // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆë¥¼ ì¤‘ì§€ì‹œí‚¤ê¸° ìœ„í•œ ë³€ìˆ˜

        // --- 1. ì¸ì¦ ê´€ë ¨ í•µì‹¬ ê¸°ëŠ¥ ---

        // í˜„ì¬ ë¡œê·¸ì¸ ìƒíƒœì¸ì§€ í•­ìƒ ê°ì‹œí•˜ëŠ” íŒŒìˆ˜ê¾¼ í•¨ìˆ˜
        auth.onAuthStateChanged(user => {
            if (user) { // ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í–ˆë‹¤ë©´
                loggedInAdmin = user;
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                document.getElementById('welcome-admin').innerText = `âœ¨ ${user.email}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤.`;
                startListenerForAdmin(user.uid); // í•´ë‹¹ ê´€ë¦¬ìì˜ ì£¼ì œë§Œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘
            } else { // ë¡œê·¸ì•„ì›ƒí–ˆë‹¤ë©´
                loggedInAdmin = null;
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('admin-panel').classList.add('hidden');
                if (unsubscribe) unsubscribe(); // ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹  ì¤‘ì§€
            }
        });

        function adminLogin() {
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            auth.signInWithEmailAndPassword(email, password).catch(error => {
                alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message);
            });
        }

        function adminLogout() {
            auth.signOut();
        }

        // --- 2. ì£¼ì œ ê´€ë¦¬ í•µì‹¬ ê¸°ëŠ¥ ---

        // ë¡œê·¸ì¸í•œ ê´€ë¦¬ìì˜ ì£¼ì œë§Œ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
        function startListenerForAdmin(adminId) {
            if (unsubscribe) unsubscribe(); // ì´ì „ ë¦¬ìŠ¤ë„ˆê°€ ìˆë‹¤ë©´ ì¤‘ì§€
            
            // â˜…â˜…â˜… í•µì‹¬: topics ì»¬ë ‰ì…˜ì—ì„œ adminIdê°€ ë¡œê·¸ì¸í•œ ê´€ë¦¬ìì˜ uidì™€ ê°™ì€ ê²ƒë§Œ í•„í„°ë§
            unsubscribe = topicsCollection.where('adminId', '==', adminId).orderBy('createdAt', 'desc')
                .onSnapshot(snapshot => {
                    currentTopics = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                    renderAdminList(currentTopics); // í™”ë©´ì— ëª©ë¡ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
                });
        }

        // ìƒˆ ì£¼ì œ ìƒì„± (ë¡œê·¸ì¸í•œ ê´€ë¦¬ìì˜ IDì™€ í•¨ê»˜ ì €ì¥)
        async function createTopic() {
            if (!loggedInAdmin) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            const title = document.getElementById('new-topic-title').value.trim();
            const itemsStr = document.getElementById('new-topic-items').value.trim();
            if (!title || !itemsStr) return alert('ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');

            const items = itemsStr.split(',').map(name => ({ name: name.trim(), votes: 0 }));
            await topicsCollection.add({
                title,
                items,
                adminId: loggedInAdmin.uid, // â˜…â˜…â˜… ë¡œê·¸ì¸í•œ ê´€ë¦¬ìì˜ UIDë¥¼ ì €ì¥
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                archivedResults: []
            });
            document.getElementById('new-topic-title').value = '';
            document.getElementById('new-topic-items').value = '';
        }

        // --- 3. ìˆ˜ì •/ì‚­ì œ ë“± ë¶€ê°€ ê¸°ëŠ¥ ---
        const editModal = document.getElementById('edit-modal');
        const saveEditBtn = document.getElementById('save-edit-btn');

        function openEditModal(topicId) {
            const topic = currentTopics.find(t => t.id === topicId);
            if (!topic) return;

            document.getElementById('edit-topic-title').value = topic.data.title;
            document.getElementById('edit-topic-items').value = topic.data.items.map(item => item.name).join(', ');
            
            saveEditBtn.replaceWith(saveEditBtn.cloneNode(true)); // ê¸°ì¡´ ì´ë²¤íŠ¸ ì œê±°
            document.getElementById('save-edit-btn').addEventListener('click', () => saveTopicChanges(topicId));

            editModal.classList.remove('hidden');
        }

        function closeEditModal() {
            editModal.classList.add('hidden');
        }

        async function saveTopicChanges(topicId) {
            const newTitle = document.getElementById('edit-topic-title').value.trim();
            const newItemsStr = document.getElementById('edit-topic-items').value.trim();

            if (!newTitle || !newItemsStr) return alert('ì£¼ì œì™€ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.');

            if (confirm('í•­ëª©ì„ ìˆ˜ì •í•˜ë©´ ê¸°ì¡´ íˆ¬í‘œ ê²°ê³¼ê°€ ëª¨ë‘ 0ìœ¼ë¡œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                const newItems = newItemsStr.split(',').map(name => ({ name: name.trim(), votes: 0 }));
                await topicsCollection.doc(topicId).update({ title: newTitle, items: newItems });
                alert('ì£¼ì œê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeEditModal();
            }
        }
        
        async function resetVotes(topicId) {
            if (!confirm('ì •ë§ë¡œ íˆ¬í‘œë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const items = currentTopics.find(t => t.id === topicId).data.items.map(item => ({ ...item, votes: 0 }));
            await topicsCollection.doc(topicId).update({ items });
            alert('íˆ¬í‘œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        async function saveResults(topicId) {
            if (!confirm('í˜„ì¬ íˆ¬í‘œ ê²°ê³¼ë¥¼ ê¸°ë¡ìœ¼ë¡œ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const topic = currentTopics.find(t => t.id === topicId);
            const newArchive = { savedAt: new Date(), results: topic.data.items };
            await topicsCollection.doc(topic.id).update({
                archivedResults: firebase.firestore.FieldValue.arrayUnion(newArchive)
            });
            alert('ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
        
        async function deleteTopic(topicId) {
             if (!confirm('ì •ë§ë¡œ ì´ ì£¼ì œë¥¼ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
             await topicsCollection.doc(topicId).delete();
             alert('ì£¼ì œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // --- 4. í™”ë©´ ë Œë”ë§ ê¸°ëŠ¥ ---
        // DBì—ì„œ ê°€ì ¸ì˜¨ ì£¼ì œ ëª©ë¡ì„ HTMLë¡œ ê·¸ë ¤ì£¼ëŠ” í•¨ìˆ˜
        function renderAdminList(topics = []) {
            const listEl = document.getElementById('topics-list');
            listEl.innerHTML = ''; // ëª©ë¡ ë¹„ìš°ê¸°
            topics.forEach(topic => {
                const totalVotes = topic.data.items.reduce((sum, item) => sum + item.votes, 0);
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-lg border";
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                           <h4 class="font-bold text-lg">${topic.data.title}</h4>
                           <p class="text-sm text-gray-500">${topic.data.items.length}ê°œ í•­ëª© / ì´ ${totalVotes}í‘œ</p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-2 flex-shrink-0 ml-2">
                           <button onclick="openEditModal('${topic.id}')" class="text-xs bg-yellow-500 text-white font-bold py-1 px-2 rounded-md hover:bg-yellow-600">âœï¸ ìˆ˜ì •</button>
                           <button onclick="saveResults('${topic.id}')" class="text-xs bg-sky-500 text-white font-bold py-1 px-2 rounded-md hover:bg-sky-600">ğŸ’¾ ì €ì¥</button>
                           <button onclick="resetVotes('${topic.id}')" class="text-xs bg-orange-500 text-white font-bold py-1 px-2 rounded-md hover:bg-orange-600">ğŸ”„ ì´ˆê¸°í™”</button>
                           <button onclick="deleteTopic('${topic.id}')" class="text-xs bg-red-600 text-white font-bold py-1 px-2 rounded-md hover:bg-red-700">âŒ ì‚­ì œ</button>
                        </div>
                    </div>
                `;
                listEl.appendChild(card);
            });
        }
    </script>
</body>
</html>
